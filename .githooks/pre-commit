#!/bin/bash
# Pre-commit hook for Hot Durham project

echo "üîç Running pre-commit checks..."

# Check for sensitive data
echo "üìã Checking for sensitive data..."
if git diff --cached --name-only | xargs grep -l "password\|api_key\|secret\|token" 2>/dev/null; then
    echo "‚ùå Sensitive data detected in staged files!"
    echo "Please remove sensitive data before committing."
    exit 1
fi

# Check for credentials in staged files
if git diff --cached --name-only | grep -E "\.(json|yaml|yml|env)$" | xargs grep -l "key\|password\|secret\|token" 2>/dev/null; then
    echo "‚ö†Ô∏è Warning: Configuration files with potential credentials detected."
    echo "Please verify no sensitive data is being committed."
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check Python syntax
echo "üìã Checking Python syntax..."
python_files=$(git diff --cached --name-only | grep "\.py$")
if [ ! -z "$python_files" ]; then
    for file in $python_files; do
        python -m py_compile "$file"
        if [ $? -ne 0 ]; then
            echo "‚ùå Python syntax error in $file"
            exit 1
        fi
    done
    echo "‚úÖ Python syntax check passed"
fi

# Check for merge conflict markers
echo "üìã Checking for merge conflict markers..."
if git diff --cached | grep -E "^(\+.*)?(<{7}|>{7}|={7})" > /dev/null; then
    echo "‚ùå Merge conflict markers found in staged changes!"
    exit 1
fi

# Run quick tests if test suite exists
if [ -f "tests/comprehensive_test_suite.py" ]; then
    echo "üìã Running quick system health check..."
    python tests/comprehensive_test_suite.py > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "‚ö†Ô∏è Warning: System health check failed"
        echo "Consider running full tests before committing"
        read -p "Continue anyway? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    else
        echo "‚úÖ System health check passed"
    fi
fi

echo "‚úÖ Pre-commit checks completed successfully!"
exit 0
